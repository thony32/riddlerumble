import { Button } from "@nextui-org/button"
import { Card } from "@nextui-org/react"
import UsersSVG from "./UsersSVG"
import { useUser } from "@/store/useUser"
import { useMutation, useQueryClient } from "@tanstack/react-query"

export interface Room {
    id: string
    delay: number
    latitude: string
    longitude: string
    level: string
    nb_players: number
    prompt: string
    user_pseudo: string
}

interface Props {
    room_list: Room[] | undefined
}

const update_room = async (room: Room, pseudo: string) => {
    const nbPlayersInt32 = room.nb_players + 1

    const response = await fetch("/api/updateRoom", {
        body: JSON.stringify({ ...room, nb_players: nbPlayersInt32, user_pseudo: `${room.user_pseudo}, ${pseudo}` }),
        method: "PUT",
        headers: { "Content-Type": "application/json" },
    })
    if (!response.ok) {
        throw new Error("Failed to join the room")
    }

    const data = await response.json()
    return data
}

function RoomList({ room_list }: Props) {
    const user = useUser((state) => state.user)
    const queryClient = useQueryClient()
    const updateRoomMutation = useMutation({
        mutationKey: ["updateRoom"],
        mutationFn: async (room: Room) => {
            return await update_room(room, user?.pseudo || "")
        },
        onError: (error) => {
            console.log(error)
        },
        onSuccess: ({ result }) => {
            // console.log("Room updated successfully! ", result)
            queryClient.invalidateQueries({ queryKey: ["allRoom"], exact: true, refetchType: "active" })
        },
    })
    return (
        <>
            {room_list?.map((room: Room) => (
                <Card
                    key={room.id}
                    className="w-full"
                >
                    <div className="w-full top-0 left-0 absolute bg-[url('/images/room-map.png')] bg-cover bg-center h-full" />
                    <div className="relative justify-end items-center gap-52 flex text-white p-7 w-full bg-gradient-to-r from-transparent to-black">
                        <h1 className="text-3xl flex items-center gap-3 font-extrabold [text-shadow:_1px_3px_5px_rgba(0,0,0,1)]">
                            {room.level == "high-level" ? (
                                <>
                                    <svg
                                        width="64px"
                                        height="64px"
                                        viewBox="0 0 1024 1024"
                                        className="icon"
                                        style={{ verticalAlign: "middle", fill: "#000000", overflow: "hidden" }}
                                        version="1.1"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="#000000"
                                    >
                                        <g
                                            id="SVGRepo_bgCarrier"
                                            strokeWidth={0}
                                        />
                                        <g
                                            id="SVGRepo_tracerCarrier"
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                        />
                                        <g id="SVGRepo_iconCarrier">
                                            <path
                                                d="M202.5984 392.3456l266.4448-275.5072c24.2688-25.088 64.3584-25.344 88.9344-0.6656l280.8832 282.1632-324.1472 306.0736-312.1152-312.064z"
                                                fill="#FFAC48"
                                            />
                                            <path
                                                d="M764.5184 323.1232l-290.9696 284.2112 44.4416 45.2096 292.5056-285.696z"
                                                fill="#FC992D"
                                            />
                                            <path
                                                d="M332.2368 273.664c-3.84 0-7.68-1.4336-10.6496-4.3008a15.36 15.36 0 0 1-0.3584-21.7088l7.5264-7.7824a15.36 15.36 0 0 1 21.7088-0.3584 15.36 15.36 0 0 1 0.3584 21.7088l-7.5264 7.7824c-3.0208 3.072-7.0144 4.6592-11.0592 4.6592z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M514.7136 719.7696c-3.9424 0-7.8848-1.4848-10.8544-4.5056L191.744 403.2a15.4112 15.4112 0 0 1-0.2048-21.5552l97.792-101.12a15.36 15.36 0 0 1 21.7088-0.3584 15.36 15.36 0 0 1 0.3584 21.7088L224.1536 392.1408l290.8672 290.8672 301.824-284.9792-269.7216-271.0016a46.9504 46.9504 0 0 0-33.5872-13.824c-12.6976 0.1024-24.576 5.1712-33.4336 14.2848L391.3728 219.2384a15.36 15.36 0 0 1-21.7088 0.3584 15.36 15.36 0 0 1-0.3584-21.7088l88.7296-91.7504c14.592-15.104 34.2528-23.5008 55.2448-23.6544 21.1968-0.256 40.7552 7.9872 55.6032 22.8864l280.8832 282.1632c2.9184 2.9184 4.5568 6.912 4.4544 11.0592-0.0512 4.1472-1.792 8.0896-4.8128 10.9056l-324.1472 306.0736c-2.9696 2.816-6.7584 4.1984-10.5472 4.1984z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M897.0752 276.4288l-351.4368 354.9696a38.38464 38.38464 0 0 1-54.0672 0.512L142.6944 293.0688c-17.1008 0.9216-32.6656 8.3456-29.696 33.4848 6.1952 52.5824 40.1408 391.8336 41.2672 407.6544 0.8704 12.032 2.7648 33.792 25.856 49.7664h701.8496c19.8144 0 36.352-15.0528 38.2464-34.7648l42.3936-442.112c3.4816-35.9424-40.1408-56.3712-65.536-30.6688z"
                                                fill="#F2C336"
                                            />
                                            <path
                                                d="M911.8208 263.5776l-6.8096 6.0416-45.2608 450.4576a39.45984 39.45984 0 0 1-12.2368 24.7296l-33.6896 31.3856h93.4912l46.7456-499.8144-42.24-12.8z"
                                                fill="#E8A200"
                                            />
                                            <path
                                                d="M518.3488 658.0736c-13.5168 0-27.0848-5.0176-37.4784-15.1552l-366.3872-355.84c-8.5504-8.2944-19.0976-7.6288-26.1632-4.1984-7.0144 3.4304-14.08 11.3152-12.8512 23.1424l14.5408 137.2672a15.36 15.36 0 0 1-13.6704 16.896c-8.448 0.9216-15.9744-5.2224-16.896-13.6704L44.9536 309.248c-2.4064-22.784 9.3696-43.9808 29.952-54.016 20.6336-10.0352 44.544-6.1952 60.9792 9.7792l366.336 355.8912c9.0112 8.7552 23.6032 8.6528 32.4608-0.3072l79.0528-79.8208a15.3088 15.3088 0 0 1 21.7088-0.1024 15.3088 15.3088 0 0 1 0.1024 21.7088l-79.0528 79.8208c-10.3936 10.5472-24.2688 15.872-38.144 15.872zM677.8368 513.2288c-3.8912 0-7.8336-1.4848-10.8032-4.4544a15.3088 15.3088 0 0 1-0.1024-21.7088l11.4176-11.52a15.3088 15.3088 0 0 1 21.7088-0.1024 15.3088 15.3088 0 0 1 0.1024 21.7088l-11.4176 11.52c-2.9696 3.0208-6.9632 4.5568-10.9056 4.5568z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M963.2768 404.3264l-84.2752 78.1312a36.77184 36.77184 0 0 0 0.0512 53.9648l65.7408 60.672 18.4832-192.768zM184.0128 481.1264L123.0336 424.6016l16.4352 165.2736 44.4928-41.0624c19.712-18.2272 19.712-49.408 0.0512-67.6864z"
                                                fill="#F58200"
                                            />
                                            <path
                                                d="M878.6432 536.0128l0.4608 0.4608 55.6544 51.3536 22.4256-177.8176-73.5744 68.1984-4.9664 57.8048z"
                                                fill="#F46800"
                                            />
                                            <path
                                                d="M837.7856 901.9392H246.9376c-33.0752 0-59.904-26.8288-59.904-59.904 0-33.0752 26.8288-59.904 59.904-59.904h590.848c33.0752 0 59.904 26.8288 59.904 59.904 0 33.0752-26.8288 59.904-59.904 59.904z"
                                                fill="#F58200"
                                            />
                                            <path
                                                d="M812.7488 788.992s32.0512 21.0944 32.0512 50.5344c0 29.3888-9.0624 52.0192-75.776 52.3776h98.3552c8.6528 0 29.3888-25.2416 29.3888-52.7872s-9.728-49.7152-84.0192-50.1248z"
                                                fill="#F46800"
                                            />
                                            <path
                                                d="M389.8368 381.78816l120.8064-120.81152 120.81152 120.81152-120.81152 120.81152z"
                                                fill="#8F93FB"
                                            />
                                            <path
                                                d="M508.2112 277.504l50.8928 106.7008-55.808 108.1856 128.9216-114.5856z"
                                                fill="#787CF5"
                                            />
                                            <path
                                                d="M510.6688 517.9392c-4.096 0-7.9872-1.6384-10.8544-4.5056l-120.7808-120.832a15.36 15.36 0 0 1 0-21.7088l120.7808-120.832c5.7856-5.7856 15.9744-5.7856 21.7088 0l120.832 120.832c2.8672 2.8672 4.5056 6.8096 4.5056 10.8544s-1.6384 7.9872-4.5056 10.8544l-120.832 120.832c-2.8672 2.8672-6.8096 4.5056-10.8544 4.5056z m-99.072-136.192l99.072 99.072 99.072-99.072-99.072-99.072-99.072 99.072z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M947.2 254.72c-20.8896-9.7792-44.8-5.4784-61.0304 10.8544L708.1472 445.44a15.3088 15.3088 0 0 0 0.1024 21.7088 15.3088 15.3088 0 0 0 21.7088-0.1024l178.0224-179.8144c8.448-8.5504 19.0464-7.9872 26.1632-4.6592 7.1168 3.328 14.336 11.1616 13.1584 23.0912l-6.7072 69.7344-101.3248 93.952c-12.4928 11.6224-19.6608 28.0576-19.6608 45.1072s7.2192 33.4848 19.7632 45.056l76.8 70.8608-11.264 117.3504a22.94784 22.94784 0 0 1-22.9376 20.8384h-28.0576c-5.2224-1.1264-10.5984-1.792-16.128-1.792H194.6624c-5.5296 0-10.9568 0.6656-16.128 1.792h-33.28c-11.8272 0-21.7088-8.8576-22.9376-20.6336l-12.8-121.088 73.0112-67.3792c12.544-11.5712 19.7632-28.0064 19.7632-45.056s-7.168-33.536-19.6608-45.1072L78.848 373.0432a15.37024 15.37024 0 0 0-21.7088 0.8192 15.37024 15.37024 0 0 0 0.8192 21.7088l103.7824 96.256c6.3488 5.888 9.8304 13.8752 9.8304 22.5792s-3.5328 16.64-9.8816 22.528L105.4208 588.8l-2.4576-23.04a15.29856 15.29856 0 0 0-16.896-13.6704 15.36 15.36 0 0 0-13.6704 16.896l19.3024 182.1696c2.5088 23.5008 19.7632 42.0352 42.0352 46.848-8.96 12.3904-14.336 27.5456-14.336 43.9808 0 41.472 33.7408 75.264 75.264 75.264h133.2224c8.4992 0 15.36-6.8608 15.36-15.36s-6.8608-15.36-15.36-15.36H194.6624c-24.5248 0-44.544-19.968-44.544-44.544 0-20.224 13.6192-37.376 32.1536-42.752h667.904c18.5344 5.376 32.1536 22.4768 32.1536 42.752 0 24.5248-19.968 44.544-44.544 44.544H401.3568c-8.4992 0-15.36 6.8608-15.36 15.36s6.8608 15.36 15.36 15.36h436.4288c41.472 0 75.264-33.7408 75.264-75.264 0-16.9472-5.6832-32.512-15.1552-45.1072 20.3264-6.1952 35.5328-24.0128 37.6832-46.2848L977.92 308.5824c2.2016-22.9376-9.8816-44.0832-30.72-53.8624z m-96.8192 259.6864c0-8.6528 3.4816-16.6912 9.8304-22.5792l76.032-70.5024-16.384 170.5984-59.5968-55.04a30.2336 30.2336 0 0 1-9.8816-22.4768z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M84.1728 534.0672a15.36 15.36 0 0 0 13.6704-16.896l-1.7408-16.384c-0.8704-8.448-8.4992-14.5408-16.896-13.6704a15.36 15.36 0 0 0-13.6704 16.896l1.7408 16.384a15.31392 15.31392 0 0 0 15.2576 13.7216c0.5632 0.0512 1.1264 0 1.6384-0.0512z"
                                                fill="#333333"
                                            />
                                            <path
                                                d="M352.1536 337.0496c-3.072 0-6.1952-1.1264-8.6016-3.328a12.78976 12.78976 0 0 1-0.8192-18.0736l11.776-12.9024a12.78976 12.78976 0 1 1 18.8928 17.2544l-11.776 12.9024c-2.56 2.7648-5.9904 4.1472-9.472 4.1472zM396.4416 288.8192c-3.072 0-6.144-1.0752-8.6016-3.328a12.79488 12.79488 0 0 1-0.8704-18.0736L448.9728 199.168a12.79488 12.79488 0 1 1 18.944 17.2032L405.9136 284.6208c-2.5088 2.7648-5.9904 4.1984-9.472 4.1984zM461.8752 385.1264a12.79488 12.79488 0 0 1-9.0624-21.8624l25.7024-25.7024c5.0176-5.0176 13.1072-5.0176 18.1248 0s5.0176 13.1072 0 18.1248l-25.7024 25.7024c-2.56 2.4576-5.8368 3.7376-9.0624 3.7376zM198.912 701.184a12.8 12.8 0 0 1-12.6976-11.4688l-8.0896-77.9776a12.8512 12.8512 0 0 1 11.4176-14.08c7.0656-0.768 13.312 4.4032 14.08 11.4176l8.0896 77.9776a12.8512 12.8512 0 0 1-11.4176 14.08c-0.4608 0-0.9216 0.0512-1.3824 0.0512zM422.1952 854.3744h-27.6992a12.8 12.8 0 0 1 0-25.6h27.6992a12.8 12.8 0 0 1 0 25.6z"
                                                fill="#FFFFFF"
                                            />
                                            <path
                                                d="M343.6544 854.3744H253.7984a12.8 12.8 0 0 1 0-25.6h89.9072c7.0656 0 12.8 5.7344 12.8 12.8s-5.7344 12.8-12.8512 12.8z"
                                                fill="#FFFFFF"
                                            />
                                        </g>
                                    </svg>
                                    High Level
                                </>
                            ) : (
                                <>
                                    <svg
                                        width="64px"
                                        height="64px"
                                        viewBox="0 0 72 72"
                                        id="emoji"
                                        xmlns="http://www.w3.org/2000/svg"
                                        fill="#000000"
                                    >
                                        <g
                                            id="SVGRepo_bgCarrier"
                                            strokeWidth={0}
                                        />
                                        <g
                                            id="SVGRepo_tracerCarrier"
                                            strokeLinecap="round"
                                            strokeLinejoin="round"
                                        />
                                        <g id="SVGRepo_iconCarrier">
                                            {" "}
                                            <g id="color">
                                                {" "}
                                                <path
                                                    fill="#D22F27"
                                                    d="M13.8451,27.9329c0,0-2.047-1.4682-0.6019-3.1236c0,0-2.2788-2.0129-0.4281-3.9039 c0,0-1.2382-4.0732,2.1382-4.309c0,0-0.3899-4.0721,4.079-3.5985c0,0,2.5018-1.8015,4.3561,0.2489c0,0,2.5324-1.6079,3.8427,0.4026"
                                                />{" "}
                                                <path
                                                    fill="#D22F27"
                                                    d="M58.1549,27.9329c0,0,2.047-1.4682,0.6019-3.1236c0,0,2.2788-2.0129,0.4281-3.9039 c0,0,1.2382-4.0732-2.1382-4.309c0,0,0.3899-4.0721-4.079-3.5985c0,0-2.5018-1.8015-4.3561,0.2489c0,0-2.5324-1.6079-3.8427,0.4026"
                                                />{" "}
                                                <circle
                                                    cx={36}
                                                    cy={36}
                                                    r={23}
                                                    fill="#FFFFFF"
                                                />{" "}
                                                <path
                                                    fill="#D22F27"
                                                    d="M49.8069,46.5463c0,0-1.58,8.43-13.81,8.76c-12.18-0.44-13.81-8.76-13.81-8.76 c-0.46-1.73-1.2401-5.76,2.28-3.81c2.7,1.5,5.38,4.37,11.53,4.55c6.16-0.18,8.83-3.05,11.53-4.55 C51.0469,40.7863,50.2769,44.8163,49.8069,46.5463z"
                                                />{" "}
                                                <path
                                                    fill="#FFFFFF"
                                                    d="M35.9981,52.7344c-6.0618,0-9.9298-3.3099-10.9113-4.9147s0.5505-1.1552,0.866-1.003 c2.3137,1.1164,4.0412,2.6979,10.0453,2.9036 M35.9981,52.7344c6.0618,0,9.9298-3.3099,10.9113-4.9147s-0.5505-1.1552-0.866-1.003 c-2.3138,1.1164-4.0412,2.6979-10.0453,2.9036"
                                                />{" "}
                                            </g>{" "}
                                            <g id="hair" /> <g id="skin" /> <g id="skin-shadow" />{" "}
                                            <g id="line">
                                                {" "}
                                                <path
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                    d="M23.4432,21.1746c2.8989-1.5543,6.1935-1.6129,8.6558,0"
                                                />{" "}
                                                <path
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                    d="M39.901,21.1746c2.8989-1.5543,6.1935-1.6129,8.6558,0"
                                                />{" "}
                                                <path
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                    d="M49.8078,46.5463c0,0-1.58,8.43-13.81,8.76c-12.18-0.44-13.81-8.76-13.81-8.76c-0.46-1.73-1.2401-5.76,2.28-3.81 c2.7,1.5,5.38,4.37,11.53,4.55c6.16-0.18,8.83-3.05,11.53-4.55C51.0478,40.7863,50.2778,44.8163,49.8078,46.5463z"
                                                />{" "}
                                                <path
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                    d="M13.8451,27.9329c0,0-2.047-1.4682-0.6019-3.1236c0,0-2.2788-2.0129-0.4281-3.9039c0,0-1.2382-4.0732,2.1382-4.309 c0,0-0.3899-4.0721,4.079-3.5985c0,0,2.5018-1.8015,4.3561,0.2489c0,0,2.5324-1.6079,3.8427,0.4026"
                                                />{" "}
                                                <circle
                                                    cx={36}
                                                    cy={36}
                                                    r={23}
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                />{" "}
                                                <path
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                    d="M58.1549,27.9329c0,0,2.047-1.4682,0.6019-3.1236c0,0,2.2788-2.0129,0.4281-3.9039c0,0,1.2382-4.0732-2.1382-4.309 c0,0,0.3899-4.0721-4.079-3.5985c0,0-2.5018-1.8015-4.3561,0.2489c0,0-2.5324-1.6079-3.8427,0.4026"
                                                />{" "}
                                                <ellipse
                                                    cx="27.7711"
                                                    cy="30.818"
                                                    rx="3.5"
                                                    ry="6.3045"
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                />{" "}
                                                <ellipse
                                                    cx="44.2289"
                                                    cy="30.8216"
                                                    rx="3.5"
                                                    ry="6.3045"
                                                    fill="none"
                                                    stroke="#000000"
                                                    strokeMiterlimit={10}
                                                    strokeWidth={2}
                                                />{" "}
                                                <circle
                                                    cx={36}
                                                    cy="38.9779"
                                                    r="2.7351"
                                                />{" "}
                                            </g>{" "}
                                            <g id="color-foreground">
                                                {" "}
                                                <ellipse
                                                    cx="27.7711"
                                                    cy="30.818"
                                                    rx="3.5"
                                                    ry="6.3045"
                                                    fill="none"
                                                    stroke="#92D3F5"
                                                    strokeMiterlimit={10}
                                                    strokeWidth="2.1"
                                                />{" "}
                                                <ellipse
                                                    cx="44.2289"
                                                    cy="30.8216"
                                                    rx="3.5"
                                                    ry="6.3045"
                                                    fill="none"
                                                    stroke="#92D3F5"
                                                    strokeMiterlimit={10}
                                                    strokeWidth="2.1"
                                                />{" "}
                                                <path d="M30.2676,30.816c0,3.04-1.32,5.31-2.5,5.31s-2.5-2.27-2.5-5.31c0-3.03,1.32-5.3,2.5-5.3S30.2676,27.7861,30.2676,30.816z" />{" "}
                                                <path d="M46.7276,30.8261c0,3.03-1.32,5.3-2.5,5.3s-2.5-2.27-2.5-5.3c0-3.04,1.32-5.31,2.5-5.31S46.7276,27.7861,46.7276,30.8261z" />{" "}
                                                <circle
                                                    cx="36.0563"
                                                    cy="38.9779"
                                                    r="2.7351"
                                                    fill="#D22F27"
                                                />{" "}
                                            </g>{" "}
                                        </g>
                                    </svg>
                                    Low Level
                                </>
                            )}
                        </h1>
                        <div className="flex gap-3 text-3xl items-center">
                            <UsersSVG className="size-16" /> <span>{room.nb_players} / 4</span>
                        </div>
                        {!room.user_pseudo.split(", ").includes(user?.pseudo!, 0) ? (
                            <Button
                                size="lg"
                                variant="shadow"
                                color="primary"
                                isLoading={updateRoomMutation.isPending}
                                onClick={() => updateRoomMutation.mutate(room)}
                            >
                                Join
                            </Button>
                        ) : (
                            <Button
                                size="lg"
                                variant="shadow"
                            >
                                Leave
                            </Button>
                        )}
                    </div>

                    <p className="absolute bottom-1 right-4 text-white text-xs">ID {room.id}</p>
                </Card>
            ))}
        </>
    )
}

export default RoomList
